name: é¡¹ç›®å¥åº·åº¦æ£€æŸ¥

on:
  # æ¯å‘¨ä¸€æ—©ä¸Š9ç‚¹è¿è¡Œ
  schedule:
    - cron: '0 9 * * 1'
    
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # PRæ—¶æ£€æŸ¥
  pull_request:
    branches: [ main, master, develop ]

jobs:
  health-check:
    name: é¡¹ç›®å¥åº·åº¦æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: æ£€æŸ¥AIå¼€å‘è§„èŒƒé›†æˆçŠ¶æ€
      id: standards-check
      run: |
        echo "ğŸ” æ£€æŸ¥AIå¼€å‘è§„èŒƒé›†æˆçŠ¶æ€..."
        HEALTH_SCORE=100
        ISSUES=()
        
        # æ£€æŸ¥CLAUDE.mdæ–‡ä»¶
        if [ -f "CLAUDE.md" ]; then
          echo "âœ… CLAUDE.mdé…ç½®æ–‡ä»¶å­˜åœ¨"
        else
          echo "âŒ ç¼ºå°‘CLAUDE.mdé…ç½®æ–‡ä»¶"
          HEALTH_SCORE=$((HEALTH_SCORE - 20))
          ISSUES+=("ç¼ºå°‘CLAUDE.mdé…ç½®æ–‡ä»¶")
        fi
        
        # æ£€æŸ¥å¼€å‘è§„èŒƒæ–‡æ¡£
        if [ -d "docs/standards" ]; then
          echo "âœ… å¼€å‘è§„èŒƒæ–‡æ¡£ç›®å½•å­˜åœ¨"
          DOC_COUNT=$(find docs/standards -name "*.md" | wc -l)
          echo "ğŸ“š è§„èŒƒæ–‡æ¡£æ•°é‡: ${DOC_COUNT}"
        else
          echo "âŒ ç¼ºå°‘å¼€å‘è§„èŒƒæ–‡æ¡£"
          HEALTH_SCORE=$((HEALTH_SCORE - 25))
          ISSUES+=("ç¼ºå°‘å¼€å‘è§„èŒƒæ–‡æ¡£ç›®å½•")
        fi
        
        # æ£€æŸ¥Git hooks
        if [ -f ".git/hooks/pre-commit" ]; then
          echo "âœ… Git pre-commit hookå·²é…ç½®"
        else
          echo "âš ï¸  ç¼ºå°‘Git pre-commit hook"
          HEALTH_SCORE=$((HEALTH_SCORE - 10))
          ISSUES+=("ç¼ºå°‘Git pre-commit hook")
        fi
        
        # æ£€æŸ¥VSCodeé…ç½®
        if [ -d ".vscode" ]; then
          echo "âœ… VSCodeé…ç½®ç›®å½•å­˜åœ¨"
        else
          echo "âš ï¸  ç¼ºå°‘VSCodeé…ç½®"
          HEALTH_SCORE=$((HEALTH_SCORE - 5))
          ISSUES+=("ç¼ºå°‘VSCodeé…ç½®")
        fi
        
        # æ£€æŸ¥README.md
        if [ -f "README.md" ]; then
          echo "âœ… README.mdæ–‡æ¡£å­˜åœ¨"
        else
          echo "âš ï¸  ç¼ºå°‘README.mdæ–‡æ¡£"
          HEALTH_SCORE=$((HEALTH_SCORE - 10))
          ISSUES+=("ç¼ºå°‘README.mdæ–‡æ¡£")
        fi
        
        echo "health_score=${HEALTH_SCORE}" >> $GITHUB_OUTPUT
        echo "issues_count=${#ISSUES[@]}" >> $GITHUB_OUTPUT
        
        # ä¿å­˜é—®é¢˜åˆ—è¡¨åˆ°æ–‡ä»¶
        printf "%s\n" "${ISSUES[@]}" > health_issues.txt
        
    - name: æ£€æŸ¥MVPç®¡ç†çŠ¶æ€
      id: mvp-check
      run: |
        echo "ğŸ“Š æ£€æŸ¥MVPç®¡ç†çŠ¶æ€..."
        
        # æ£€æŸ¥MVPç›®å½•
        if [ -d "docs/mvp-milestones" ]; then
          MVP_COUNT=$(find docs/mvp-milestones -name "MVP-*.md" | wc -l)
          echo "âœ… MVPé‡Œç¨‹ç¢‘ç›®å½•å­˜åœ¨ï¼ŒåŒ…å« ${MVP_COUNT} ä¸ªè®°å½•"
          
          if [ $MVP_COUNT -gt 0 ]; then
            LATEST_MVP=$(ls -1t docs/mvp-milestones/MVP-*.md | head -1)
            echo "ğŸ“ æœ€æ–°MVPè®°å½•: $(basename "$LATEST_MVP")"
          fi
        else
          echo "âš ï¸  ç¼ºå°‘MVPé‡Œç¨‹ç¢‘ç›®å½•"
          MVP_COUNT=0
        fi
        
        # æ£€æŸ¥MVPçŠ¶æ€æ–‡ä»¶
        if [ -f "MVP_STATUS.md" ]; then
          echo "âœ… MVPçŠ¶æ€æ–‡ä»¶å­˜åœ¨"
        else
          echo "âš ï¸  ç¼ºå°‘MVPçŠ¶æ€æ–‡ä»¶"
        fi
        
        echo "mvp_count=${MVP_COUNT}" >> $GITHUB_OUTPUT
        
    - name: ä»£ç è´¨é‡æ£€æŸ¥
      id: code-check
      run: |
        echo "ğŸ’» æ‰§è¡Œä»£ç è´¨é‡æ£€æŸ¥..."
        
        # ç»Ÿè®¡ä»£ç ä¿¡æ¯
        TOTAL_COMMITS=$(git rev-list --count HEAD)
        RECENT_COMMITS=$(git log --oneline --since="1 month ago" | wc -l)
        
        echo "ğŸ“ˆ æ€»æäº¤æ•°: ${TOTAL_COMMITS}"
        echo "ğŸ“… æœ¬æœˆæäº¤æ•°: ${RECENT_COMMITS}"
        
        # æ£€æŸ¥æäº¤ä¿¡æ¯è§„èŒƒ
        STANDARD_COMMITS=$(git log --oneline --since="1 month ago" --grep="^feat:\|^fix:\|^docs:\|^chore:\|^agent:" | wc -l)
        if [ $RECENT_COMMITS -gt 0 ]; then
          COMMIT_RATIO=$((STANDARD_COMMITS * 100 / RECENT_COMMITS))
          echo "ğŸ“‹ è§„èŒƒæäº¤æ¯”ä¾‹: ${COMMIT_RATIO}%"
        else
          COMMIT_RATIO=0
        fi
        
        echo "commit_ratio=${COMMIT_RATIO}" >> $GITHUB_OUTPUT
        echo "total_commits=${TOTAL_COMMITS}" >> $GITHUB_OUTPUT
        echo "recent_commits=${RECENT_COMMITS}" >> $GITHUB_OUTPUT
        
    - name: Agenté¡¹ç›®ä¸“ç”¨æ£€æŸ¥
      if: contains(github.repository, 'agent') || contains(github.repository, 'Agent')
      id: agent-check
      run: |
        echo "ğŸ¤– æ‰§è¡ŒAgenté¡¹ç›®ä¸“ç”¨æ£€æŸ¥..."
        AGENT_SCORE=100
        
        # æ£€æŸ¥Agent PRDæ–‡æ¡£
        if find docs -name "*-Agent-PRD.md" | grep -q .; then
          echo "âœ… Agent PRDæ–‡æ¡£å­˜åœ¨"
        else
          echo "âŒ ç¼ºå°‘Agent PRDæ–‡æ¡£"
          AGENT_SCORE=$((AGENT_SCORE - 30))
        fi
        
        # æ£€æŸ¥Agentå¼€å‘æ£€æŸ¥æ¸…å•
        if [ -f "docs/AGENT_DEVELOPMENT_CHECKLIST.md" ]; then
          echo "âœ… Agentå¼€å‘æ£€æŸ¥æ¸…å•å­˜åœ¨"
        else
          echo "âš ï¸  ç¼ºå°‘Agentå¼€å‘æ£€æŸ¥æ¸…å•"
          AGENT_SCORE=$((AGENT_SCORE - 20))
        fi
        
        # æ£€æŸ¥Agentç›¸å…³é…ç½®
        if grep -q "agent" CLAUDE.md 2>/dev/null; then
          echo "âœ… CLAUDE.mdåŒ…å«Agenté…ç½®"
        else
          echo "âš ï¸  CLAUDE.mdç¼ºå°‘Agentä¸“ç”¨é…ç½®"
          AGENT_SCORE=$((AGENT_SCORE - 15))
        fi
        
        echo "agent_score=${AGENT_SCORE}" >> $GITHUB_OUTPUT
        
    - name: ç”Ÿæˆå¥åº·åº¦æŠ¥å‘Š
      run: |
        echo "ğŸ“‹ ç”Ÿæˆé¡¹ç›®å¥åº·åº¦æŠ¥å‘Š..."
        
        cat > health_report.md << EOF
        # é¡¹ç›®å¥åº·åº¦æŠ¥å‘Š
        
        **ç”Ÿæˆæ—¶é—´**: $(date)
        **é¡¹ç›®**: ${{ github.repository }}
        **åˆ†æ”¯**: ${{ github.ref_name }}
        
        ## ğŸ“Š æ€»ä½“è¯„åˆ†
        - **å¼€å‘è§„èŒƒé›†æˆ**: ${{ steps.standards-check.outputs.health_score }}/100
        - **MVPç®¡ç†çŠ¶æ€**: ${{ steps.mvp-check.outputs.mvp_count }} ä¸ªé‡Œç¨‹ç¢‘è®°å½•
        - **æäº¤ä¿¡æ¯è§„èŒƒ**: ${{ steps.code-check.outputs.commit_ratio }}%
        EOF
        
        if [ "${{ steps.agent-check.outputs.agent_score }}" != "" ]; then
          echo "- **Agenté¡¹ç›®é…ç½®**: ${{ steps.agent-check.outputs.agent_score }}/100" >> health_report.md
        fi
        
        cat >> health_report.md << EOF
        
        ## ğŸ” è¯¦ç»†æ£€æŸ¥ç»“æœ
        
        ### å¼€å‘è§„èŒƒé›†æˆçŠ¶æ€
        EOF
        
        if [ -f "health_issues.txt" ] && [ -s "health_issues.txt" ]; then
          echo "**å‘ç°çš„é—®é¢˜**:" >> health_report.md
          cat health_issues.txt | sed 's/^/- âŒ /' >> health_report.md
        else
          echo "âœ… æ‰€æœ‰å¼€å‘è§„èŒƒé…ç½®å®Œæ•´" >> health_report.md
        fi
        
        cat >> health_report.md << EOF
        
        ### ä»£ç ç»Ÿè®¡
        - æ€»æäº¤æ•°: ${{ steps.code-check.outputs.total_commits }}
        - æœ¬æœˆæäº¤æ•°: ${{ steps.code-check.outputs.recent_commits }}
        - è§„èŒƒæäº¤æ¯”ä¾‹: ${{ steps.code-check.outputs.commit_ratio }}%
        
        ## ğŸ’¡ æ”¹è¿›å»ºè®®
        EOF
        
        if [ "${{ steps.standards-check.outputs.health_score }}" -lt 90 ]; then
          echo "- ğŸ”§ è¿è¡Œé¡¹ç›®åˆå§‹åŒ–è„šæœ¬å®Œå–„é…ç½®: \`./scripts/init-project.sh\`" >> health_report.md
        fi
        
        if [ "${{ steps.mvp-check.outputs.mvp_count }}" -eq 0 ]; then
          echo "- ğŸ“‹ åˆ›å»ºé¦–ä¸ªMVPé‡Œç¨‹ç¢‘è®°å½•: \`./scripts/mvp-backup.sh \"åˆå§‹ç‰ˆæœ¬\"\`" >> health_report.md
        fi
        
        if [ "${{ steps.code-check.outputs.commit_ratio }}" -lt 70 ]; then
          echo "- ğŸ“ æ”¹è¿›æäº¤ä¿¡æ¯æ ¼å¼ï¼Œä½¿ç”¨æ ‡å‡†å‰ç¼€ (feat:, fix:, docs:, agent:)" >> health_report.md
        fi
        
        echo "" >> health_report.md
        echo "---" >> health_report.md
        echo "*æŠ¥å‘Šç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ*" >> health_report.md
        
    - name: ä¸Šä¼ å¥åº·åº¦æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: project-health-report
        path: health_report.md
        retention-days: 30
        
    - name: è¾“å‡ºæŠ¥å‘Šæ‘˜è¦
      run: |
        echo "ğŸ“‹ é¡¹ç›®å¥åº·åº¦æ£€æŸ¥å®Œæˆ"
        echo "ğŸ¥ å¥åº·åº¦è¯„åˆ†: ${{ steps.standards-check.outputs.health_score }}/100"
        echo "ğŸ”¢ é—®é¢˜æ•°é‡: ${{ steps.standards-check.outputs.issues_count }}"
        echo "ğŸ“Š MVPè®°å½•æ•°: ${{ steps.mvp-check.outputs.mvp_count }}"
        echo "ğŸ“ æäº¤è§„èŒƒç‡: ${{ steps.code-check.outputs.commit_ratio }}%"
        
        if [ "${{ steps.standards-check.outputs.health_score }}" -lt 70 ]; then
          echo "âš ï¸  é¡¹ç›®å¥åº·åº¦è¾ƒä½ï¼Œå»ºè®®ç«‹å³æ”¹è¿›"
        elif [ "${{ steps.standards-check.outputs.health_score }}" -lt 90 ]; then
          echo "âš ï¸  é¡¹ç›®å¥åº·åº¦ä¸­ç­‰ï¼Œæœ‰æ”¹è¿›ç©ºé—´"
        else
          echo "âœ… é¡¹ç›®å¥åº·åº¦è‰¯å¥½"
        fi
        
    # å¦‚æœå¥åº·åº¦å¤ªä½ï¼Œåˆ›å»ºIssue
    - name: åˆ›å»ºæ”¹è¿›Issue
      if: steps.standards-check.outputs.health_score < 70
      uses: actions/github-script@v7
      with:
        script: |
          const healthScore = ${{ steps.standards-check.outputs.health_score }};
          const issuesCount = ${{ steps.standards-check.outputs.issues_count }};
          
          const issueBody = `
          ## ğŸ¥ é¡¹ç›®å¥åº·åº¦å‘Šè­¦
          
          **å¥åº·åº¦è¯„åˆ†**: ${healthScore}/100
          **å‘ç°é—®é¢˜**: ${issuesCount} ä¸ª
          
          ## ğŸ” ä¸»è¦é—®é¢˜
          ${process.env.HEALTH_ISSUES || 'è¯¦è§å¥åº·åº¦æŠ¥å‘Š'}
          
          ## ğŸ”§ å»ºè®®ä¿®å¤æ­¥éª¤
          1. è¿è¡Œé¡¹ç›®åˆå§‹åŒ–è„šæœ¬é›†æˆAIå¼€å‘è§„èŒƒ
          2. é…ç½®ç¼ºå¤±çš„å¼€å‘ç¯å¢ƒæ–‡ä»¶
          3. å®Œå–„é¡¹ç›®æ–‡æ¡£å’Œé…ç½®
          4. å»ºç«‹MVPç®¡ç†æµç¨‹
          
          ## ğŸ› ï¸ ä¿®å¤å‘½ä»¤
          \`\`\`bash
          # é›†æˆAIå¼€å‘è§„èŒƒ
          ./scripts/init-project.sh $(pwd)
          
          # æ£€æŸ¥MVPçŠ¶æ€
          ./scripts/mvp-check.sh
          
          # åˆ›å»ºé¦–ä¸ªMVPè®°å½•
          ./scripts/mvp-backup.sh "åˆå§‹ç‰ˆæœ¬"
          \`\`\`
          
          ---
          *æ­¤Issueç”±å¥åº·åº¦æ£€æŸ¥è‡ªåŠ¨åˆ›å»º*
          `;
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ğŸ¥ é¡¹ç›®å¥åº·åº¦å‘Šè­¦ - è¯„åˆ†: ${healthScore}/100`,
            body: issueBody,
            labels: ['health-check', 'improvement-needed']
          });