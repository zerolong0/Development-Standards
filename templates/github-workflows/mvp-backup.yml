name: MVPè‡ªåŠ¨å¤‡ä»½å’Œç‰ˆæœ¬ç®¡ç†

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      mvp_description:
        description: 'MVPåŠŸèƒ½æè¿°'
        required: true
        default: 'åŠŸèƒ½æ›´æ–°'
      mvp_type:
        description: 'MVPç±»å‹'
        required: true
        default: 'feature'
        type: choice
        options:
        - feature
        - bugfix  
        - enhancement
      create_tag:
        description: 'åˆ›å»ºGitæ ‡ç­¾'
        required: false
        type: boolean
        default: false
        
  # å®šæœŸæ£€æŸ¥ï¼ˆæ¯å¤©æ™šä¸Š10ç‚¹ï¼‰
  schedule:
    - cron: '0 22 * * *'
    
  # å½“æœ‰ç‰¹å®šæäº¤æ¨¡å¼æ—¶è§¦å‘
  push:
    branches: [ main, master, develop ]
    paths-ignore:
      - 'docs/mvp-milestones/**'
      - 'MVP_STATUS.md'

jobs:
  check-mvp-status:
    name: æ£€æŸ¥MVPçŠ¶æ€
    runs-on: ubuntu-latest
    outputs:
      should_backup: ${{ steps.check.outputs.should_backup }}
      backup_score: ${{ steps.check.outputs.backup_score }}
      
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²
        
    - name: è®¾ç½®Gité…ç½®
      run: |
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
        
    - name: æ£€æŸ¥MVPçŠ¶æ€
      id: check
      run: |
        # æ£€æŸ¥æ˜¯å¦éœ€è¦å¤‡ä»½
        if [ -f "scripts/mvp-check.sh" ]; then
          chmod +x scripts/mvp-check.sh
          ./scripts/mvp-check.sh > mvp_check_output.txt || EXIT_CODE=$?
          
          # æ ¹æ®é€€å‡ºç åˆ¤æ–­æ˜¯å¦éœ€è¦å¤‡ä»½
          if [ "${EXIT_CODE:-0}" -ge 2 ]; then
            echo "should_backup=true" >> $GITHUB_OUTPUT
            echo "backup_score=high" >> $GITHUB_OUTPUT
          elif [ "${EXIT_CODE:-0}" -eq 1 ]; then
            echo "should_backup=moderate" >> $GITHUB_OUTPUT  
            echo "backup_score=medium" >> $GITHUB_OUTPUT
          else
            echo "should_backup=false" >> $GITHUB_OUTPUT
            echo "backup_score=low" >> $GITHUB_OUTPUT
          fi
          
          # è¾“å‡ºæ£€æŸ¥ç»“æœ
          cat mvp_check_output.txt
        else
          echo "MVPæ£€æŸ¥è„šæœ¬ä¸å­˜åœ¨"
          echo "should_backup=false" >> $GITHUB_OUTPUT
          echo "backup_score=unknown" >> $GITHUB_OUTPUT
        fi
        
    - name: ä¸Šä¼ æ£€æŸ¥æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: mvp-check-report
        path: mvp_check_output.txt
        retention-days: 7

  auto-backup:
    name: æ‰§è¡ŒMVPè‡ªåŠ¨å¤‡ä»½
    runs-on: ubuntu-latest
    needs: check-mvp-status
    if: |
      github.event_name == 'workflow_dispatch' || 
      needs.check-mvp-status.outputs.should_backup == 'true' ||
      (github.event_name == 'schedule' && needs.check-mvp-status.outputs.should_backup != 'false')
      
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: è®¾ç½®Gité…ç½®
      run: |
        git config --global user.name 'MVP Auto Backup'
        git config --global user.email 'mvp-backup@github-actions.com'
        
    - name: å‡†å¤‡MVPå¤‡ä»½å‚æ•°
      id: params
      run: |
        # è®¾ç½®MVPæè¿°
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          MVP_DESC="${{ github.event.inputs.mvp_description }}"
          MVP_TYPE="${{ github.event.inputs.mvp_type }}"
          CREATE_TAG="${{ github.event.inputs.create_tag }}"
        elif [ "${{ github.event_name }}" = "schedule" ]; then
          MVP_DESC="å®šæœŸè‡ªåŠ¨å¤‡ä»½ - $(date +'%Y-%m-%d')"
          MVP_TYPE="enhancement"
          CREATE_TAG="false"
        else
          # Pushè§¦å‘çš„å¤‡ä»½
          MVP_DESC="ä»£ç æ›´æ–°å¤‡ä»½ - $(git log -1 --pretty=format:'%s')"
          MVP_TYPE="feature"
          CREATE_TAG="false"
        fi
        
        echo "mvp_description=${MVP_DESC}" >> $GITHUB_OUTPUT
        echo "mvp_type=${MVP_TYPE}" >> $GITHUB_OUTPUT
        echo "create_tag=${CREATE_TAG}" >> $GITHUB_OUTPUT
        
    - name: æ‰§è¡ŒMVPå¤‡ä»½
      run: |
        if [ -f "scripts/mvp-backup.sh" ]; then
          chmod +x scripts/mvp-backup.sh
          
          # æ„å»ºå¤‡ä»½å‘½ä»¤
          BACKUP_CMD="./scripts/mvp-backup.sh"
          BACKUP_CMD="${BACKUP_CMD} -t '${{ steps.params.outputs.mvp_type }}'"
          BACKUP_CMD="${BACKUP_CMD} -r origin"
          
          if [ "${{ steps.params.outputs.create_tag }}" = "true" ]; then
            BACKUP_CMD="${BACKUP_CMD} --tag"
          fi
          
          BACKUP_CMD="${BACKUP_CMD} '${{ steps.params.outputs.mvp_description }}'"
          
          # æ‰§è¡Œå¤‡ä»½
          eval $BACKUP_CMD
        else
          echo "âŒ MVPå¤‡ä»½è„šæœ¬ä¸å­˜åœ¨"
          exit 1
        fi
        
    - name: åˆ›å»ºPull Requestï¼ˆå¦‚æœéœ€è¦ï¼‰
      if: github.ref != 'refs/heads/main' && github.ref != 'refs/heads/master'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: |
          chore: MVPå¤‡ä»½ - ${{ steps.params.outputs.mvp_description }}
          
          ğŸ¤– è‡ªåŠ¨ç”Ÿæˆçš„MVPé‡Œç¨‹ç¢‘å¤‡ä»½
          - ç±»å‹: ${{ steps.params.outputs.mvp_type }}
          - æ—¶é—´: ${{ github.run_started_at }}
          - è§¦å‘: ${{ github.event_name }}
          
        title: 'MVPå¤‡ä»½: ${{ steps.params.outputs.mvp_description }}'
        body: |
          ## ğŸ¯ MVPè‡ªåŠ¨å¤‡ä»½
          
          **å¤‡ä»½ä¿¡æ¯:**
          - ğŸ“ æè¿°: ${{ steps.params.outputs.mvp_description }}
          - ğŸ·ï¸  ç±»å‹: ${{ steps.params.outputs.mvp_type }}
          - â° æ—¶é—´: ${{ github.run_started_at }}
          - ğŸ”„ è§¦å‘æ–¹å¼: ${{ github.event_name }}
          
          **åŒ…å«æ›´æ”¹:**
          - ğŸ“‹ MVPé‡Œç¨‹ç¢‘è®°å½•
          - ğŸ“Š é¡¹ç›®çŠ¶æ€æ›´æ–°
          - ğŸ¤– è‡ªåŠ¨ç”Ÿæˆçš„æ–‡æ¡£
          
          **æ£€æŸ¥æ¸…å•:**
          - [x] MVPåŠŸèƒ½è®°å½•å®Œæ•´
          - [x] Gitæäº¤å†å²æ¸…æ™°
          - [x] æ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆ
          - [ ] äººå·¥å®¡æŸ¥é€šè¿‡
          
          ---
          *æ­¤PRç”±GitHub Actionsè‡ªåŠ¨åˆ›å»º*
          
        branch: mvp-backup-${{ github.run_number }}
        delete-branch: true
        
  notify:
    name: å‘é€é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [check-mvp-status, auto-backup]
    if: always()
    
    steps:
    - name: å‡†å¤‡é€šçŸ¥å†…å®¹
      id: notification
      run: |
        if [ "${{ needs.auto-backup.result }}" = "success" ]; then
          STATUS="âœ… æˆåŠŸ"
          COLOR="good"
        elif [ "${{ needs.auto-backup.result }}" = "failure" ]; then
          STATUS="âŒ å¤±è´¥"  
          COLOR="danger"
        elif [ "${{ needs.auto-backup.result }}" = "skipped" ]; then
          STATUS="â­ï¸ è·³è¿‡"
          COLOR="warning"
        else
          STATUS="â“ æœªçŸ¥"
          COLOR="warning"
        fi
        
        echo "status=${STATUS}" >> $GITHUB_OUTPUT
        echo "color=${COLOR}" >> $GITHUB_OUTPUT
        
    # è¿™é‡Œå¯ä»¥æ·»åŠ å„ç§é€šçŸ¥æ–¹å¼ï¼Œå¦‚Slackã€ä¼ä¸šå¾®ä¿¡ç­‰
    - name: è¾“å‡ºé€šçŸ¥ä¿¡æ¯
      run: |
        echo "ğŸ“Š MVPå¤‡ä»½çŠ¶æ€: ${{ steps.notification.outputs.status }}"
        echo "ğŸ” æ£€æŸ¥ç»“æœ: ${{ needs.check-mvp-status.outputs.backup_score }}"
        echo "ğŸ¯ é¡¹ç›®: ${{ github.repository }}"
        echo "ğŸŒ¿ åˆ†æ”¯: ${{ github.ref_name }}"
        echo "â° æ—¶é—´: ${{ github.run_started_at }}"

  # Agenté¡¹ç›®ä¸“ç”¨æ£€æŸ¥
  agent-specific-checks:
    name: Agenté¡¹ç›®ä¸“ç”¨æ£€æŸ¥
    runs-on: ubuntu-latest
    if: contains(github.repository, 'agent') || contains(github.repository, 'Agent')
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: æ£€æŸ¥Agenté¡¹ç›®æ–‡ä»¶
      run: |
        echo "ğŸ¤– æ‰§è¡ŒAgenté¡¹ç›®ä¸“ç”¨æ£€æŸ¥..."
        
        # æ£€æŸ¥Agent PRDæ–‡æ¡£
        if find docs -name "*-Agent-PRD.md" | grep -q .; then
          echo "âœ… æ‰¾åˆ°Agent PRDæ–‡æ¡£"
        else
          echo "âš ï¸  æœªæ‰¾åˆ°Agent PRDæ–‡æ¡£"
        fi
        
        # æ£€æŸ¥Agentå¼€å‘æ£€æŸ¥æ¸…å•
        if [ -f "docs/AGENT_DEVELOPMENT_CHECKLIST.md" ]; then
          echo "âœ… Agentå¼€å‘æ£€æŸ¥æ¸…å•å­˜åœ¨"
        else
          echo "âš ï¸  ç¼ºå°‘Agentå¼€å‘æ£€æŸ¥æ¸…å•"
        fi
        
        # æ£€æŸ¥Agentç›¸å…³æäº¤
        AGENT_COMMITS=$(git log --oneline --since="1 week ago" --grep="agent:" | wc -l)
        echo "ğŸ“Š æœ¬å‘¨Agentç›¸å…³æäº¤: ${AGENT_COMMITS}ä¸ª"
        
        if [ $AGENT_COMMITS -gt 0 ]; then
          echo "ğŸ“ Agentç›¸å…³æäº¤:"
          git log --oneline --since="1 week ago" --grep="agent:" | head -5
        fi