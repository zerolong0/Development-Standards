name: AIå¼€å‘è§„èŒƒæ£€æŸ¥

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  standards-compliance:
    name: å¼€å‘è§„èŒƒåˆè§„æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: æ£€æŸ¥CLAUDE.mdé…ç½®æ–‡ä»¶
      run: |
        if [ ! -f "CLAUDE.md" ]; then
          echo "âŒ ç¼ºå°‘CLAUDE.mdé…ç½®æ–‡ä»¶"
          echo "è¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤é›†æˆAIå¼€å‘è§„èŒƒ:"
          echo "  ./scripts/init-project.sh \$(pwd) [é¡¹ç›®ç±»å‹]"
          exit 1
        fi
        
        echo "âœ… CLAUDE.mdé…ç½®æ–‡ä»¶å­˜åœ¨"
        
        # æ£€æŸ¥CLAUDE.mdå†…å®¹å®Œæ•´æ€§
        REQUIRED_SECTIONS=("é¡¹ç›®ä¿¡æ¯" "å¼€å‘è§„èŒƒ" "Claudeåä½œæŒ‡å—" "é¡¹ç›®æ£€æŸ¥æ¸…å•")
        for section in "${REQUIRED_SECTIONS[@]}"; do
          if ! grep -q "$section" CLAUDE.md; then
            echo "âš ï¸  CLAUDE.mdç¼ºå°‘'$section'éƒ¨åˆ†"
          else
            echo "âœ… æ‰¾åˆ°'$section'éƒ¨åˆ†"
          fi
        done
        
    - name: éªŒè¯å¼€å‘è§„èŒƒæ–‡æ¡£
      run: |
        if [ ! -d "docs/standards" ]; then
          echo "âŒ ç¼ºå°‘å¼€å‘è§„èŒƒæ–‡æ¡£ç›®å½•"
          exit 1
        fi
        
        REQUIRED_DOCS=(
          "DEVELOPMENT_BEST_PRACTICES.md"
          "PROJECT_WORKFLOW.md"
          "TECHNICAL_DECISIONS_TEMPLATE.md"
          "CONTEXT_ENGINEERING_GUIDE.md"
        )
        
        for doc in "${REQUIRED_DOCS[@]}"; do
          if [ -f "docs/standards/$doc" ]; then
            echo "âœ… æ‰¾åˆ°è§„èŒƒæ–‡æ¡£: $doc"
          else
            echo "âš ï¸  ç¼ºå°‘è§„èŒƒæ–‡æ¡£: $doc"
          fi
        done
        
    - name: æ£€æŸ¥Gitæäº¤ä¿¡æ¯è§„èŒƒ
      run: |
        echo "ğŸ“ æ£€æŸ¥æäº¤ä¿¡æ¯è§„èŒƒ..."
        
        # è·å–æœ¬æ¬¡PRæˆ–pushçš„æäº¤
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          COMMITS=$(git log --pretty=format:"%s" ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
        else
          COMMITS=$(git log --pretty=format:"%s" -10)
        fi
        
        TOTAL_COMMITS=0
        STANDARD_COMMITS=0
        
        while IFS= read -r commit_msg; do
          if [ -n "$commit_msg" ]; then
            TOTAL_COMMITS=$((TOTAL_COMMITS + 1))
            
            # æ£€æŸ¥æ˜¯å¦ç¬¦åˆè§„èŒƒæ ¼å¼
            if [[ "$commit_msg" =~ ^(feat|fix|docs|style|refactor|test|chore|agent)(\(.+\))?\:.+ ]]; then
              STANDARD_COMMITS=$((STANDARD_COMMITS + 1))
              echo "âœ… $commit_msg"
            else
              echo "âš ï¸  ä¸è§„èŒƒ: $commit_msg"
            fi
          fi
        done <<< "$COMMITS"
        
        if [ $TOTAL_COMMITS -gt 0 ]; then
          COMPLIANCE_RATE=$((STANDARD_COMMITS * 100 / TOTAL_COMMITS))
          echo "ğŸ“Š æäº¤ä¿¡æ¯è§„èŒƒç‡: ${COMPLIANCE_RATE}%"
          
          if [ $COMPLIANCE_RATE -lt 80 ]; then
            echo "âš ï¸  æäº¤ä¿¡æ¯è§„èŒƒç‡è¾ƒä½ï¼Œå»ºè®®æ”¹è¿›"
            echo "æ­£ç¡®æ ¼å¼: <ç±»å‹>[å¯é€‰èŒƒå›´]: <æè¿°>"
            echo "ç±»å‹: feat, fix, docs, style, refactor, test, chore, agent"
          fi
        fi
        
    - name: Agenté¡¹ç›®ä¸“ç”¨æ£€æŸ¥
      if: contains(github.repository, 'agent') || contains(github.repository, 'Agent')
      run: |
        echo "ğŸ¤– æ‰§è¡ŒAgenté¡¹ç›®ä¸“ç”¨æ£€æŸ¥..."
        
        # æ£€æŸ¥Agent PRDæ–‡æ¡£
        if find docs -name "*-Agent-PRD.md" | grep -q .; then
          echo "âœ… æ‰¾åˆ°Agent PRDæ–‡æ¡£"
          PRD_FILE=$(find docs -name "*-Agent-PRD.md" | head -1)
          echo "ğŸ“„ PRDæ–‡æ¡£: $PRD_FILE"
          
          # æ£€æŸ¥PRDæ–‡æ¡£å…³é”®éƒ¨åˆ†
          REQUIRED_PRD_SECTIONS=(
            "Agentèº«ä»½è®¾è®¡"
            "è®¤çŸ¥èƒ½åŠ›è®¾è®¡" 
            "äº¤äº’è¡Œä¸ºè®¾è®¡"
            "çŸ¥è¯†ä½“ç³»è®¾è®¡"
            "æµ‹è¯•éªŒè¯è®¾è®¡"
          )
          
          for section in "${REQUIRED_PRD_SECTIONS[@]}"; do
            if grep -q "$section" "$PRD_FILE"; then
              echo "âœ… PRDåŒ…å«: $section"
            else
              echo "âš ï¸  PRDç¼ºå°‘: $section"
            fi
          done
        else
          echo "âŒ ç¼ºå°‘Agent PRDæ–‡æ¡£"
          echo "è¯·ä½¿ç”¨æ¨¡æ¿åˆ›å»º: docs/templates/AGENT_PRD_TEMPLATE.md"
        fi
        
        # æ£€æŸ¥Agentå¼€å‘æ£€æŸ¥æ¸…å•
        if [ -f "docs/AGENT_DEVELOPMENT_CHECKLIST.md" ]; then
          echo "âœ… Agentå¼€å‘æ£€æŸ¥æ¸…å•å­˜åœ¨"
        else
          echo "âš ï¸  ç¼ºå°‘Agentå¼€å‘æ£€æŸ¥æ¸…å•"
        fi
        
        # æ£€æŸ¥Agentç›¸å…³æäº¤
        AGENT_COMMITS=$(git log --oneline --since="2 weeks ago" --grep="agent:" | wc -l)
        echo "ğŸ“Š è¿‘2å‘¨Agentç›¸å…³æäº¤: ${AGENT_COMMITS}ä¸ª"
        
    - name: æ£€æŸ¥VSCodeé…ç½®
      run: |
        if [ -d ".vscode" ]; then
          echo "âœ… VSCodeé…ç½®ç›®å½•å­˜åœ¨"
          
          CONFIG_FILES=("settings.json" "tasks.json")
          for file in "${CONFIG_FILES[@]}"; do
            if [ -f ".vscode/$file" ]; then
              echo "âœ… VSCodeé…ç½®: $file"
            else
              echo "âš ï¸  ç¼ºå°‘VSCodeé…ç½®: $file"
            fi
          done
        else
          echo "âš ï¸  ç¼ºå°‘VSCodeé…ç½®ç›®å½•"
        fi
        
    - name: æ£€æŸ¥Git hooksé…ç½®
      run: |
        if [ -f ".git/hooks/pre-commit" ]; then
          echo "âœ… Git pre-commit hookå·²é…ç½®"
          
          # æ£€æŸ¥hookæ˜¯å¦å¯æ‰§è¡Œ
          if [ -x ".git/hooks/pre-commit" ]; then
            echo "âœ… Pre-commit hookå¯æ‰§è¡Œ"
          else
            echo "âš ï¸  Pre-commit hookä¸å¯æ‰§è¡Œ"
          fi
        else
          echo "âš ï¸  ç¼ºå°‘Git pre-commit hook"
        fi
        
        if [ -f ".git/hooks/commit-msg" ]; then
          echo "âœ… Git commit-msg hookå·²é…ç½®"
        else
          echo "âš ï¸  ç¼ºå°‘Git commit-msg hook"
        fi
        
    - name: ç”Ÿæˆåˆè§„æŠ¥å‘Š
      run: |
        echo "ğŸ“‹ ç”Ÿæˆå¼€å‘è§„èŒƒåˆè§„æŠ¥å‘Š..."
        
        cat > compliance_report.md << EOF
        # AIå¼€å‘è§„èŒƒåˆè§„æ£€æŸ¥æŠ¥å‘Š
        
        **æ£€æŸ¥æ—¶é—´**: $(date)
        **é¡¹ç›®**: ${{ github.repository }}
        **åˆ†æ”¯**: ${{ github.ref_name }}
        **äº‹ä»¶**: ${{ github.event_name }}
        
        ## âœ… åˆè§„æ£€æŸ¥ç»“æœ
        
        ### æ ¸å¿ƒé…ç½®æ–‡ä»¶
        EOF
        
        if [ -f "CLAUDE.md" ]; then
          echo "- âœ… CLAUDE.mdé…ç½®æ–‡ä»¶" >> compliance_report.md
        else
          echo "- âŒ CLAUDE.mdé…ç½®æ–‡ä»¶" >> compliance_report.md
        fi
        
        if [ -d "docs/standards" ]; then
          echo "- âœ… å¼€å‘è§„èŒƒæ–‡æ¡£ç›®å½•" >> compliance_report.md
        else
          echo "- âŒ å¼€å‘è§„èŒƒæ–‡æ¡£ç›®å½•" >> compliance_report.md
        fi
        
        if [ -d ".vscode" ]; then
          echo "- âœ… VSCodeé…ç½®ç›®å½•" >> compliance_report.md
        else
          echo "- âš ï¸  VSCodeé…ç½®ç›®å½•" >> compliance_report.md
        fi
        
        if [ -f ".git/hooks/pre-commit" ]; then
          echo "- âœ… Git pre-commit hook" >> compliance_report.md
        else
          echo "- âš ï¸  Git pre-commit hook" >> compliance_report.md
        fi
        
        cat >> compliance_report.md << EOF
        
        ### Agenté¡¹ç›®ä¸“ç”¨æ£€æŸ¥
        EOF
        
        if contains(github.repository, 'agent') || contains(github.repository, 'Agent'); then
          if find docs -name "*-Agent-PRD.md" | grep -q .; then
            echo "- âœ… Agent PRDæ–‡æ¡£" >> compliance_report.md
          else
            echo "- âŒ Agent PRDæ–‡æ¡£" >> compliance_report.md
          fi
          
          if [ -f "docs/AGENT_DEVELOPMENT_CHECKLIST.md" ]; then
            echo "- âœ… Agentå¼€å‘æ£€æŸ¥æ¸…å•" >> compliance_report.md
          else
            echo "- âš ï¸  Agentå¼€å‘æ£€æŸ¥æ¸…å•" >> compliance_report.md
          fi
        else
          echo "- ğŸ”„ éAgenté¡¹ç›®ï¼Œè·³è¿‡Agentä¸“ç”¨æ£€æŸ¥" >> compliance_report.md
        fi
        
        echo "" >> compliance_report.md
        echo "---" >> compliance_report.md
        echo "*æŠ¥å‘Šç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ*" >> compliance_report.md
        
    - name: ä¸Šä¼ åˆè§„æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: compliance-report-${{ github.run_number }}
        path: compliance_report.md
        retention-days: 7
        
    - name: æ£€æŸ¥ç»“æœæ‘˜è¦
      run: |
        echo "ğŸ“Š AIå¼€å‘è§„èŒƒåˆè§„æ£€æŸ¥å®Œæˆ"
        echo ""
        echo "ğŸ” æ£€æŸ¥é¡¹ç›®:"
        echo "  âœ… CLAUDE.mdé…ç½®æ–‡ä»¶"
        echo "  âœ… å¼€å‘è§„èŒƒæ–‡æ¡£"
        echo "  âœ… æäº¤ä¿¡æ¯æ ¼å¼"
        echo "  âœ… VSCodeé…ç½®"
        echo "  âœ… Git hooks"
        if [[ "${{ github.repository }}" == *"agent"* ]] || [[ "${{ github.repository }}" == *"Agent"* ]]; then
          echo "  ğŸ¤– Agenté¡¹ç›®ä¸“ç”¨æ£€æŸ¥"
        fi
        echo ""
        echo "ğŸ“‹ è¯¦ç»†æŠ¥å‘Šå·²ä¸Šä¼ åˆ°Artifacts"