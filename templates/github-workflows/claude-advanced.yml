name: Claude Codeé«˜çº§å·¥ä½œæµ

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      mode:
        description: 'æ‰§è¡Œæ¨¡å¼'
        required: true
        default: 'full-audit'
        type: choice
        options:
        - quick-check
        - security-focus
        - performance-focus  
        - full-audit
      auto_fix:
        description: 'è‡ªåŠ¨ä¿®å¤é—®é¢˜'
        required: false
        type: boolean
        default: true

jobs:
  multi-agent-analysis:
    name: å¤šAgentåä½œåˆ†æ
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '[claude-analysis]')
    
    outputs:
      analysis_score: ${{ steps.analysis.outputs.score }}
      security_issues: ${{ steps.analysis.outputs.security_issues }}
      performance_score: ${{ steps.analysis.outputs.performance_score }}
      
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        npm ci
        npm install -g @anthropic/claude-code-cli
        
    - name: å¤šAgentåä½œåˆ†æ
      id: analysis
      run: |
        echo "ğŸ¤– å¯åŠ¨å¤šAgentåä½œåˆ†æ..."
        
        # åˆ†æAgent - éœ€æ±‚ç†è§£å’ŒæŠ€æœ¯è¯„ä¼°
        ANALYSIS_RESULT=$(claude-code agent \
          --role=analyst \
          --task="å…¨é¢åˆ†æé¡¹ç›®ç»“æ„ã€æŠ€æœ¯å€ºåŠ¡ã€æ”¹è¿›æœºä¼š" \
          --output=json)
        
        # æå–åˆ†æè¯„åˆ†
        ANALYSIS_SCORE=$(echo "$ANALYSIS_RESULT" | jq -r '.score // 0')
        echo "analysis_score=${ANALYSIS_SCORE}" >> $GITHUB_OUTPUT
        
        # è´¨é‡Agent - å®‰å…¨å’Œæ€§èƒ½è¯„ä¼°  
        QUALITY_RESULT=$(claude-code agent \
          --role=qa \
          --task="å®‰å…¨æ¼æ´æ‰«æã€æ€§èƒ½ç“¶é¢ˆåˆ†æã€ä»£ç è´¨é‡è¯„ä¼°" \
          --output=json)
          
        SECURITY_ISSUES=$(echo "$QUALITY_RESULT" | jq -r '.security.issues_count // 0')
        PERFORMANCE_SCORE=$(echo "$QUALITY_RESULT" | jq -r '.performance.score // 0')
        
        echo "security_issues=${SECURITY_ISSUES}" >> $GITHUB_OUTPUT
        echo "performance_score=${PERFORMANCE_SCORE}" >> $GITHUB_OUTPUT
        
        # ä¿å­˜è¯¦ç»†åˆ†ææŠ¥å‘Š
        echo "$ANALYSIS_RESULT" > multi-agent-analysis.json
        echo "$QUALITY_RESULT" > quality-assessment.json
        
    - name: ä¸Šä¼ åˆ†ææŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: multi-agent-analysis-${{ github.run_number }}
        path: |
          multi-agent-analysis.json
          quality-assessment.json
        retention-days: 30

  intelligent-security-scan:
    name: AIé©±åŠ¨å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    needs: multi-agent-analysis
    if: needs.multi-agent-analysis.outputs.security_issues > 0 || github.event.inputs.mode == 'security-focus' || github.event.inputs.mode == 'full-audit'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: Claudeå®‰å…¨å®¡æŸ¥
      id: security-review
      run: |
        echo "ğŸ”’ æ‰§è¡ŒAIé©±åŠ¨å®‰å…¨å®¡æŸ¥..."
        
        # å…¨é¢å®‰å…¨æ‰«æ
        claude-code security-review \
          --comprehensive \
          --focus="authentication,data-validation,crypto,injection" \
          --severity="medium,high,critical" \
          --output=security-report.json \
          --auto-fix=${{ github.event.inputs.auto_fix || 'true' }}
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å…³é”®å®‰å…¨é—®é¢˜
        CRITICAL_COUNT=$(jq -r '.issues | map(select(.severity == "critical")) | length' security-report.json)
        HIGH_COUNT=$(jq -r '.issues | map(select(.severity == "high")) | length' security-report.json)
        
        echo "critical_issues=${CRITICAL_COUNT}" >> $GITHUB_OUTPUT
        echo "high_issues=${HIGH_COUNT}" >> $GITHUB_OUTPUT
        
        if [ "$CRITICAL_COUNT" -gt 0 ]; then
          echo "âŒ å‘ç° ${CRITICAL_COUNT} ä¸ªä¸¥é‡å®‰å…¨é—®é¢˜"
          exit 1
        elif [ "$HIGH_COUNT" -gt 3 ]; then
          echo "âš ï¸ å‘ç° ${HIGH_COUNT} ä¸ªé«˜å±å®‰å…¨é—®é¢˜"
        fi
        
    - name: åˆ›å»ºå®‰å…¨é—®é¢˜Issue
      if: steps.security-review.outputs.critical_issues > 0 || steps.security-review.outputs.high_issues > 5
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = JSON.parse(fs.readFileSync('security-report.json', 'utf8'));
          
          const criticalIssues = report.issues.filter(i => i.severity === 'critical');
          const highIssues = report.issues.filter(i => i.severity === 'high');
          
          const issueBody = `
          ## ğŸ”’ å®‰å…¨æ‰«æå‘Šè­¦
          
          **æ‰«ææ—¶é—´**: ${new Date().toISOString()}
          **ä¸¥é‡é—®é¢˜**: ${criticalIssues.length}ä¸ª
          **é«˜å±é—®é¢˜**: ${highIssues.length}ä¸ª
          
          ### ğŸš¨ ä¸¥é‡å®‰å…¨é—®é¢˜
          ${criticalIssues.map(issue => `
          - **${issue.type}**: ${issue.description}
            - ä½ç½®: ${issue.file}:${issue.line}
            - é£é™©: ${issue.risk}
            - ä¿®å¤: ${issue.fix}
          `).join('\n')}
          
          ### âš ï¸ é«˜å±é—®é¢˜
          ${highIssues.slice(0, 5).map(issue => `
          - **${issue.type}**: ${issue.description}
            - ä½ç½®: ${issue.file}:${issue.line}
          `).join('\n')}
          
          ## ğŸ› ï¸ ä¿®å¤å»ºè®®
          1. ç«‹å³ä¿®å¤æ‰€æœ‰ä¸¥é‡å®‰å…¨é—®é¢˜
          2. ä¼˜å…ˆå¤„ç†é«˜å±é—®é¢˜
          3. è¿è¡Œ \`claude-code security-review --auto-fix\` è‡ªåŠ¨ä¿®å¤
          4. æ›´æ–°å®‰å…¨ä¾èµ–å’Œé…ç½®
          
          ---
          *æ­¤Issueç”±Claude Codeå®‰å…¨æ‰«æè‡ªåŠ¨åˆ›å»º*
          `;
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ğŸ”’ å®‰å…¨å‘Šè­¦ - ${criticalIssues.length}ä¸ªä¸¥é‡é—®é¢˜ + ${highIssues.length}ä¸ªé«˜å±é—®é¢˜`,
            body: issueBody,
            labels: ['security', 'urgent', 'claude-generated']
          });
    
    - name: ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: security-report-${{ github.run_number }}
        path: security-report.json
        retention-days: 90

  performance-optimization:
    name: æ€§èƒ½ä¼˜åŒ–åˆ†æ
    runs-on: ubuntu-latest
    needs: multi-agent-analysis
    if: needs.multi-agent-analysis.outputs.performance_score < 80 || github.event.inputs.mode == 'performance-focus' || github.event.inputs.mode == 'full-audit'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Node.jså’Œä¾èµ–
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: å®‰è£…åˆ†æå·¥å…·
      run: |
        npm ci
        npm install -g lighthouse @bundle-analyzer/cli
        
    - name: Claudeæ€§èƒ½å®¡è®¡
      id: performance-audit
      run: |
        echo "âš¡ æ‰§è¡ŒAIé©±åŠ¨æ€§èƒ½å®¡è®¡..."
        
        # æ€§èƒ½åˆ†æ
        claude-code performance-audit \
          --comprehensive \
          --target="web" \
          --metrics="core-web-vitals,bundle-size,runtime" \
          --output=performance-report.json
        
        # ç”Ÿæˆä¼˜åŒ–å»ºè®®
        claude-code optimize \
          --type=performance \
          --auto-apply=${{ github.event.inputs.auto_fix || 'false' }} \
          --output=optimization-plan.json
        
        # æå–å…³é”®æŒ‡æ ‡
        PERFORMANCE_SCORE=$(jq -r '.overall_score // 0' performance-report.json)
        CRITICAL_ISSUES=$(jq -r '.critical_issues | length' performance-report.json)
        
        echo "performance_score=${PERFORMANCE_SCORE}" >> $GITHUB_OUTPUT
        echo "critical_issues=${CRITICAL_ISSUES}" >> $GITHUB_OUTPUT
        
    - name: è¿è¡ŒLighthouseå®¡è®¡
      run: |
        if [ -f "package.json" ] && grep -q "next" package.json; then
          echo "æ£€æµ‹åˆ°Next.jsé¡¹ç›®ï¼Œè¿è¡Œå¼€å‘æœåŠ¡å™¨..."
          npm run build
          npm run start &
          sleep 10
          
          lighthouse http://localhost:3000 \
            --output=json \
            --output-path=lighthouse-report.json \
            --chrome-flags="--headless --no-sandbox"
            
          pkill -f "npm run start"
        fi
        
    - name: Bundleåˆ†æ
      if: contains(github.repository, 'next') || contains(github.repository, 'react')
      run: |
        if [ -f ".next/analyze" ]; then
          echo "ç”ŸæˆBundleåˆ†ææŠ¥å‘Š..."
          npx @next/bundle-analyzer analyze
        fi
        
    - name: ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
      run: |
        echo "ğŸ“Š ç”Ÿæˆç»¼åˆæ€§èƒ½æŠ¥å‘Š..."
        
        cat > performance-summary.md << EOF
        # æ€§èƒ½ä¼˜åŒ–æŠ¥å‘Š
        
        **åˆ†ææ—¶é—´**: $(date)
        **é¡¹ç›®**: ${{ github.repository }}
        **æ€§èƒ½è¯„åˆ†**: $(jq -r '.overall_score' performance-report.json)/100
        
        ## ğŸ¯ å…³é”®æŒ‡æ ‡
        $(jq -r '.metrics | to_entries[] | "- **\(.key)**: \(.value)"' performance-report.json)
        
        ## âš ï¸ æ€§èƒ½é—®é¢˜
        $(jq -r '.critical_issues[] | "- **\(.type)**: \(.description) (\(.impact))"' performance-report.json)
        
        ## ğŸ› ï¸ ä¼˜åŒ–å»ºè®®
        $(jq -r '.optimizations[] | "- \(.description) (é¢„æœŸæå‡: \(.impact))"' optimization-plan.json)
        
        ---
        *ç”±Claude Codeæ€§èƒ½å®¡è®¡è‡ªåŠ¨ç”Ÿæˆ*
        EOF
        
    - name: ä¸Šä¼ æ€§èƒ½æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: performance-reports-${{ github.run_number }}
        path: |
          performance-report.json
          optimization-plan.json
          lighthouse-report.json
          performance-summary.md
        retention-days: 30

  intelligent-testing:
    name: æ™ºèƒ½æµ‹è¯•ç”Ÿæˆå’Œæ‰§è¡Œ
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®æµ‹è¯•ç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: Claudeæ™ºèƒ½æµ‹è¯•ç”Ÿæˆ
      run: |
        echo "ğŸ§ª ç”Ÿæˆæ™ºèƒ½æµ‹è¯•ç”¨ä¾‹..."
        
        # åˆ†æä»£ç è¦†ç›–ç‡ç¼ºå£
        claude-code test analyze \
          --coverage-report \
          --identify-gaps \
          --output=test-analysis.json
        
        # è‡ªåŠ¨ç”Ÿæˆç¼ºå¤±çš„æµ‹è¯•
        claude-code test generate \
          --pattern=TDD \
          --coverage-target=85% \
          --frameworks=jest,cypress \
          --auto-apply=true
        
    - name: æ‰§è¡Œæµ‹è¯•å¥—ä»¶
      run: |
        # å¹¶è¡Œæ‰§è¡Œä¸åŒç±»å‹çš„æµ‹è¯•
        npm run test:unit -- --coverage --passWithNoTests &
        UNIT_PID=$!
        
        if [ -f "cypress.config.js" ]; then
          npm run test:e2e:headless &
          E2E_PID=$!
        fi
        
        # ç­‰å¾…æµ‹è¯•å®Œæˆ
        wait $UNIT_PID
        UNIT_EXIT_CODE=$?
        
        if [ -n "$E2E_PID" ]; then
          wait $E2E_PID
          E2E_EXIT_CODE=$?
        else
          E2E_EXIT_CODE=0
        fi
        
        # æ£€æŸ¥æµ‹è¯•ç»“æœ
        if [ $UNIT_EXIT_CODE -ne 0 ] || [ $E2E_EXIT_CODE -ne 0 ]; then
          echo "âŒ æµ‹è¯•å¤±è´¥"
          exit 1
        fi
        
    - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-reports-${{ github.run_number }}
        path: |
          coverage/
          cypress/reports/
          test-analysis.json
        retention-days: 30

  deployment-readiness:
    name: éƒ¨ç½²å°±ç»ªæ€§æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: [multi-agent-analysis, intelligent-security-scan, performance-optimization, intelligent-testing]
    if: always()
    
    steps:
    - name: è¯„ä¼°éƒ¨ç½²å°±ç»ªæ€§
      id: readiness-check
      run: |
        echo "ğŸ“‹ è¯„ä¼°éƒ¨ç½²å°±ç»ªæ€§..."
        
        # æ”¶é›†æ‰€æœ‰æ£€æŸ¥ç»“æœ
        ANALYSIS_SCORE=${{ needs.multi-agent-analysis.outputs.analysis_score || '0' }}
        SECURITY_ISSUES=${{ needs.intelligent-security-scan.outputs.critical_issues || '0' }}
        PERFORMANCE_SCORE=${{ needs.performance-optimization.outputs.performance_score || '0' }}
        
        # è®¡ç®—æ•´ä½“å°±ç»ªæ€§è¯„åˆ†
        if [ "$SECURITY_ISSUES" -gt 0 ]; then
          READINESS_SCORE=0
          READINESS_STATUS="BLOCKED"
        elif [ "$PERFORMANCE_SCORE" -lt 60 ]; then
          READINESS_SCORE=30
          READINESS_STATUS="NOT_READY"
        elif [ "$ANALYSIS_SCORE" -lt 70 ]; then
          READINESS_SCORE=60
          READINESS_STATUS="NEEDS_IMPROVEMENT"
        else
          READINESS_SCORE=90
          READINESS_STATUS="READY"
        fi
        
        echo "readiness_score=${READINESS_SCORE}" >> $GITHUB_OUTPUT
        echo "readiness_status=${READINESS_STATUS}" >> $GITHUB_OUTPUT
        
        # ç”Ÿæˆå°±ç»ªæ€§æŠ¥å‘Š
        cat > deployment-readiness.md << EOF
        # ğŸš€ éƒ¨ç½²å°±ç»ªæ€§è¯„ä¼°
        
        **è¯„ä¼°æ—¶é—´**: $(date)
        **æ•´ä½“è¯„åˆ†**: ${READINESS_SCORE}/100
        **éƒ¨ç½²çŠ¶æ€**: ${READINESS_STATUS}
        
        ## ğŸ“Š æ£€æŸ¥ç»“æœæ±‡æ€»
        - **ä»£ç åˆ†æ**: ${ANALYSIS_SCORE}/100
        - **å®‰å…¨é—®é¢˜**: ${SECURITY_ISSUES}ä¸ªä¸¥é‡é—®é¢˜
        - **æ€§èƒ½è¯„åˆ†**: ${PERFORMANCE_SCORE}/100
        - **æµ‹è¯•çŠ¶æ€**: ${{ needs.intelligent-testing.result }}
        
        ## ğŸ¯ éƒ¨ç½²å»ºè®®
        $(if [ "$READINESS_STATUS" = "READY" ]; then
          echo "âœ… é¡¹ç›®å·²å‡†å¤‡å¥½éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"
        elif [ "$READINESS_STATUS" = "NEEDS_IMPROVEMENT" ]; then
          echo "âš ï¸ å»ºè®®è§£å†³æ€§èƒ½å’Œè´¨é‡é—®é¢˜åå†éƒ¨ç½²"
        else
          echo "âŒ å­˜åœ¨é˜»å¡é—®é¢˜ï¼Œä¸å»ºè®®éƒ¨ç½²"
        fi)
        
        EOF
        
    - name: é€šçŸ¥éƒ¨ç½²çŠ¶æ€
      uses: actions/github-script@v7
      with:
        script: |
          const readinessStatus = '${{ steps.readiness-check.outputs.readiness_status }}';
          const readinessScore = '${{ steps.readiness-check.outputs.readiness_score }}';
          
          let emoji = 'âœ…';
          let color = 'green';
          
          if (readinessStatus === 'BLOCKED') {
            emoji = 'ğŸš«';
            color = 'red';
          } else if (readinessStatus === 'NOT_READY') {
            emoji = 'âš ï¸';
            color = 'yellow';
          }
          
          await github.rest.repos.createCommitStatus({
            owner: context.repo.owner,
            repo: context.repo.repo,
            sha: context.sha,
            state: readinessStatus === 'READY' ? 'success' : 'failure',
            description: `éƒ¨ç½²å°±ç»ªæ€§: ${readinessScore}/100 - ${readinessStatus}`,
            context: 'claude-code/deployment-readiness'
          });
          
    - name: ä¸Šä¼ å°±ç»ªæ€§æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: deployment-readiness-${{ github.run_number }}
        path: deployment-readiness.md
        retention-days: 60